<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Motion Blur Generator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';

        const ProcessingStatus = { IDLE: 'IDLE', PROCESSING: 'PROCESSING', COMPLETED: 'COMPLETED' };
        const FPS_OPTIONS = [30, 60, 120, 240];

        const App = () => {
            const [file, setFile] = useState(null);
            const [status, setStatus] = useState(ProcessingStatus.IDLE);
            const [options, setOptions] = useState({ fps: 60, blurStrength: 50 });
            const [videoSrc, setVideoSrc] = useState("");
            const [downloadUrl, setDownloadUrl] = useState(null);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const requestRef = useRef();

            const handleFile = (e) => {
                const selectedFile = e.target.files?.[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    setVideoSrc(URL.createObjectURL(selectedFile));
                    setStatus(ProcessingStatus.IDLE);
                    setDownloadUrl(null);
                }
            };

            const startProcessing = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (!video || !canvas) return;

                // 画質向上：動画のオリジナルサイズに合わせる
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                setStatus(ProcessingStatus.PROCESSING);
                const chunks = [];
                const stream = canvas.captureStream(options.fps);
                
                // ビットレートを上げて画質を維持
                const recorder = new MediaRecorder(stream, { 
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 25000000 // 25Mbps
                });

                recorder.ondataavailable = (e) => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    setDownloadUrl(URL.createObjectURL(blob));
                    setStatus(ProcessingStatus.COMPLETED);
                };

                video.currentTime = 0;
                video.play();
                recorder.start();
                mediaRecorderRef.current = recorder;

                // 強度MAXでも真っ暗にならないように計算式を修正 (0.01〜0.3の範囲に制限)
                const alpha = Math.max(0.01, (100 - options.blurStrength) / 330);

                const render = () => {
                    if (video.paused || video.ended) {
                        if (recorder.state !== 'inactive') recorder.stop();
                        return;
                    }
                    ctx.globalAlpha = alpha;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    requestRef.current = requestAnimationFrame(render);
                };
                render();
            };

            const reset = () => {
                cancelAnimationFrame(requestRef.current);
                if (mediaRecorderRef.current) mediaRecorderRef.current.stop();
                setFile(null);
                setVideoSrc("");
                setDownloadUrl(null);
                setStatus(ProcessingStatus.IDLE);
            };

            return (
                <div class="max-w-4xl mx-auto p-8 space-y-8">
                    <h1 class="text-3xl font-bold text-center text-blue-400">High-Quality Motion Blur</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="p-6 border-2 border-dashed border-slate-700 rounded-xl text-center">
                                <input type="file" accept="video/*" onChange={handleFile} class="hidden" id="v-up" />
                                <label htmlFor="v-up" class="cursor-pointer text-blue-300 hover:text-white">
                                    {file ? file.name : "動画を選択してください"}
                                </label>
                            </div>

                            <div class="bg-slate-900 p-4 rounded-xl space-y-4">
                                <label class="block text-sm">ターゲットFPS: {options.fps}</label>
                                <div class="flex gap-2">
                                    {FPS_OPTIONS.map(f => (
                                        <button key={f} onClick={()=>setOptions({...options, fps:f})} class={`flex-1 py-1 rounded ${options.fps===f?'bg-blue-600':'bg-slate-700'}`}>{f}</button>
                                    ))}
                                </div>
                                <label class="block text-sm">ブラー強度: {options.blurStrength}%</label>
                                <input type="range" value={options.blurStrength} onChange={(e)=>setOptions({...options, blurStrength:e.target.value})} class="w-full accent-blue-500" />
                                
                                <button onClick={status === ProcessingStatus.COMPLETED ? reset : startProcessing} disabled={!file || status === ProcessingStatus.PROCESSING} class="w-full py-3 bg-blue-600 rounded-lg font-bold disabled:opacity-50">
                                    {status === ProcessingStatus.PROCESSING ? "処理中..." : status === ProcessingStatus.COMPLETED ? "リセット" : "生成開始"}
                                </button>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <video ref={videoRef} src={videoSrc} class="hidden" muted playsInline />
                            <canvas ref={canvasRef} class="w-full rounded-xl bg-black aspect-video object-contain border border-slate-800" />
                            {downloadUrl && (
                                <a href={downloadUrl} download="motion-blur.webm" class="block text-center p-3 bg-green-600 rounded-lg font-bold animate-bounce">
                                    動画を保存（高品質）
                                </a>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
